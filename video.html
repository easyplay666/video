<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A-B è§†é¢‘å­¦ä¹ æ’­æ”¾å™¨ (ä¿®å¤ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    
    <style>
        .plyr { height: 100%; max-height: 70vh; border-radius: 0.75rem; --plyr-color-main: #2563eb; }
        body { background-color: #0f172a; color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <div class="flex-1 flex flex-col p-4 space-y-4 overflow-y-auto">
        
        <div class="bg-gray-800 p-4 rounded-xl shadow-lg flex gap-4 items-center">
            <div class="flex bg-gray-700 rounded-lg p-1 shrink-0">
                <button onclick="switchMode('youtube')" id="tab-yt" class="px-4 py-2 rounded-md text-sm font-bold bg-blue-600 transition-all">YouTube</button>
                <button onclick="switchMode('local')" id="tab-local" class="px-4 py-2 rounded-md text-sm font-bold text-gray-400 hover:text-white transition-all">æœ¬åœ°è§†é¢‘</button>
            </div>

            <div id="input-youtube" class="flex-1 flex gap-2">
                <input type="text" id="yt-url" placeholder="ç²˜è´´ YouTube ç½‘å€ (ä¾‹å¦‚ https://youtu.be/...)" 
                       class="flex-1 bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500 font-mono text-sm">
                <button onclick="loadYouTube()" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg font-bold shadow-lg shadow-blue-900/50">æ’­æ”¾</button>
            </div>

            <div id="input-local" class="flex-1 hidden">
                <input type="file" id="local-file" accept="video/*" class="block w-full text-sm text-gray-400
                  file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0
                  file:text-sm file:font-semibold file:bg-blue-600 file:text-white
                  hover:file:bg-blue-500 cursor-pointer"/>
            </div>
        </div>

        <div class="w-full bg-black rounded-xl shadow-2xl relative group aspect-video flex justify-center items-center overflow-hidden border border-gray-700">
            <video id="player" playsinline controls class="w-full h-full"></video>
            
            <div id="loop-indicator" class="absolute top-4 right-4 bg-blue-600/90 px-3 py-1 rounded text-xs font-bold hidden backdrop-blur-md shadow-lg z-50 animate-pulse">
                ğŸ”„ A-B å¾ªç¯ä¸­
            </div>
        </div>

        <div class="grid grid-cols-4 gap-4">
            <button onclick="setA()" id="btn-a" class="bg-gray-700 hover:bg-gray-600 text-white py-4 rounded-xl text-xl font-bold border-l-4 border-transparent transition-all shadow-md active:scale-95">
                ğŸ…°ï¸ è®¾èµ·ç‚¹ (A)
            </button>
            <button onclick="setB()" id="btn-b" disabled class="bg-gray-700 hover:bg-gray-600 text-white py-4 rounded-xl text-xl font-bold border-l-4 border-transparent transition-all shadow-md opacity-50 cursor-not-allowed active:scale-95">
                ğŸ…±ï¸ è®¾ç»ˆç‚¹ (B)
            </button>
            <button onclick="clearLoop()" class="bg-red-900/40 hover:bg-red-800 text-red-200 py-4 rounded-xl text-lg font-bold shadow-md active:scale-95">
                âŒ æ¸…é™¤
            </button>
            
            <div class="bg-gray-800 rounded-xl flex flex-col items-center justify-center relative group cursor-pointer hover:bg-gray-700 transition">
                <span class="text-[10px] text-gray-400 uppercase tracking-wider mb-1">æ’­æ”¾é€Ÿåº¦</span>
                <select id="speed-select" onchange="changeSpeed(this.value)" class="bg-transparent text-white font-bold text-lg text-center outline-none cursor-pointer appearance-none w-full h-full absolute inset-0 z-10">
                    <option value="0.5" class="bg-gray-800">0.5x</option>
                    <option value="0.75" class="bg-gray-800">0.75x</option>
                    <option value="1.0" selected class="bg-gray-800">1.0x</option>
                    <option value="1.25" class="bg-gray-800">1.25x</option>
                    <option value="1.5" class="bg-gray-800">1.5x</option>
                    <option value="2.0" class="bg-gray-800">2.0x</option>
                </select>
                <div class="text-xl font-bold pointer-events-none z-0" id="speed-display">1.0x</div>
            </div>
        </div>
        
        <div class="text-center text-xs text-gray-500">
            å¿«æ·é”®ï¼š[ç©ºæ ¼] æ’­æ”¾/æš‚åœ &nbsp;|&nbsp; [â†] Aç‚¹ &nbsp;|&nbsp; [â†’] Bç‚¹ &nbsp;|&nbsp; [Esc] æ¸…é™¤
        </div>
    </div>

    <div class="w-80 bg-gray-900 border-l border-gray-800 flex flex-col shadow-2xl z-20">
        <div class="p-4 border-b border-gray-800 bg-gray-900 flex justify-between items-center">
            <h2 class="text-sm font-bold text-gray-300 flex items-center gap-2">
                ğŸ“œ æ’­æ”¾å†å²
            </h2>
            <button onclick="clearHistory()" class="text-xs text-gray-600 hover:text-red-400 transition">æ¸…ç©º</button>
        </div>
        <div id="history-list" class="flex-1 overflow-y-auto p-3 space-y-3"></div>
    </div>

    <script>
        let player = null;
        let loopA = null;
        let loopB = null;
        let currentMode = 'youtube';
        let historyData = JSON.parse(localStorage.getItem('video_ab_history_v2')) || [];
        let currentMedia = { id: null, title: null, type: null, duration: 0 };

        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ– Plyrï¼Œå…³é”®ä¿®å¤ï¼šyoutube é…ç½®
            player = new Plyr('#player', {
                controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen'],
                keyboard: { focused: true, global: true },
                speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] },
                youtube: { 
                    noCookie: true, // å…³é”®ä¿®å¤ï¼šä½¿ç”¨ youtube-nocookie.com
                    rel: 0, 
                    showinfo: 0, 
                    iv_load_policy: 3, 
                    modestbranding: 1 
                }
            });

            // æ ¸å¿ƒ A-B é€»è¾‘
            player.on('timeupdate', () => {
                if (loopA !== null && loopB !== null) {
                    // ç²¾åº¦ä¿æŠ¤ï¼šå¢åŠ  0.2ç§’ å®¹é”™
                    if (player.currentTime >= loopB || player.currentTime < loopA - 0.5) {
                        player.currentTime = loopA;
                        player.play().catch(()=>{}); // é˜²æ­¢æŠ¥é”™
                    }
                }
                if (Math.floor(player.currentTime) % 5 === 0) saveHistory();
            });

            player.on('ratechange', () => {
                 document.getElementById('speed-display').innerText = player.speed + 'x';
                 document.getElementById('speed-select').value = player.speed;
            });

            renderHistoryUI();
        });

        // === åŠŸèƒ½å‡½æ•° ===

        function switchMode(mode) {
            currentMode = mode;
            const btnYt = document.getElementById('tab-yt');
            const btnLocal = document.getElementById('tab-local');
            const inputYt = document.getElementById('input-youtube');
            const inputLocal = document.getElementById('input-local');

            if (mode === 'youtube') {
                btnYt.className = "px-4 py-2 rounded-md text-sm font-bold bg-blue-600 text-white shadow-lg";
                btnLocal.className = "px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-white";
                inputYt.classList.remove('hidden'); inputYt.classList.add('flex');
                inputLocal.classList.add('hidden');
            } else {
                btnLocal.className = "px-4 py-2 rounded-md text-sm font-bold bg-blue-600 text-white shadow-lg";
                btnYt.className = "px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-white";
                inputLocal.classList.remove('hidden');
                inputYt.classList.remove('flex'); inputYt.classList.add('hidden');
            }
        }

        function loadYouTube(urlOverride = null, startAt = 0, loopPoints = null) {
            const url = urlOverride || document.getElementById('yt-url').value;
            if (!url) return alert("è¯·è¾“å…¥ YouTube ç½‘å€");

            // æ›´å¼ºçš„æ­£åˆ™åŒ¹é…
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            
            if (match && match[2].length === 11) {
                const videoId = match[2];
                
                // è®¾ç½®æ’­æ”¾æº
                player.source = {
                    type: 'video',
                    sources: [{ src: videoId, provider: 'youtube' }]
                };

                currentMedia = { id: videoId, title: `YouTube (${videoId})`, type: 'youtube' };
                clearLoop(false);

                // é”™è¯¯å¤„ç†
                setTimeout(() => {
                    const poster = document.querySelector('.plyr__poster');
                    if(poster) poster.style.display = 'none'; // å¼ºåˆ¶éšè—å°é¢ä»¥é˜²é®æŒ¡é”™è¯¯
                }, 1000);

                player.once('ready', () => {
                    if (startAt > 0) player.currentTime = startAt;
                    if (loopPoints) {
                        loopA = loopPoints.a;
                        loopB = loopPoints.b;
                        updateLoopUI();
                    }
                    saveHistory();
                });
            } else {
                alert("æ— æ³•è¯†åˆ«è¿™ä¸ª YouTube é“¾æ¥ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å®Œæ•´");
            }
        }

        document.getElementById('local-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const url = URL.createObjectURL(file);
            player.source = {
                type: 'video',
                sources: [{ src: url, type: file.type || 'video/mp4' }]
            };

            currentMedia = { id: file.name, title: file.name, type: 'local' };
            clearLoop(false);

            const saved = historyData.find(h => h.id === file.name && h.type === 'local');
            player.once('ready', () => {
                if (saved) {
                    // æ¸©æŸ”æç¤º
                    player.currentTime = saved.timestamp;
                    if (saved.loop) {
                        loopA = saved.loop.a;
                        loopB = saved.loop.b;
                        updateLoopUI();
                    }
                    // è‡ªåŠ¨å¼€å§‹æ’­æ”¾
                    player.play().catch(e => console.log("éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾"));
                }
                saveHistory();
            });
        });

        // === å¾ªç¯æ§åˆ¶ ===
        function setA() {
            loopA = player.currentTime;
            const btnA = document.getElementById('btn-a');
            const btnB = document.getElementById('btn-b');
            
            btnA.innerHTML = `<span class="text-xs opacity-60">èµ·ç‚¹</span><br>${formatTime(loopA)}`;
            btnA.classList.add('bg-blue-600', 'border-blue-300');
            btnA.classList.remove('bg-gray-700', 'border-transparent');
            
            btnB.disabled = false;
            btnB.classList.remove('opacity-50', 'cursor-not-allowed');
            btnB.classList.add('animate-pulse', 'bg-blue-900');
            
            loopB = null;
            document.getElementById('loop-indicator').classList.add('hidden');
        }

        function setB() {
            if (loopA === null) return;
            let temp = player.currentTime;
            if (temp < loopA) [loopA, temp] = [temp, loopA]; // è‡ªåŠ¨çº æ­£åå‘
            
            loopB = temp;
            player.currentTime = loopA;
            player.play();
            updateLoopUI();
            saveHistory();
        }

        function updateLoopUI() {
            const btnA = document.getElementById('btn-a');
            const btnB = document.getElementById('btn-b');
            
            btnA.innerHTML = `<span class="text-xs opacity-60">èµ·ç‚¹</span><br>${formatTime(loopA)}`;
            btnB.innerHTML = `<span class="text-xs opacity-60">ç»ˆç‚¹</span><br>${formatTime(loopB)}`;
            
            btnB.classList.remove('animate-pulse', 'bg-gray-700', 'border-transparent');
            btnB.classList.add('bg-blue-600', 'border-blue-300');
            
            document.getElementById('loop-indicator').classList.remove('hidden');
        }

        function clearLoop(updateUI = true) {
            loopA = null; loopB = null;
            if(updateUI) {
                const btnA = document.getElementById('btn-a');
                const btnB = document.getElementById('btn-b');
                
                btnA.innerHTML = `ğŸ…°ï¸ è®¾èµ·ç‚¹ (A)`;
                btnA.className = "bg-gray-700 hover:bg-gray-600 text-white py-4 rounded-xl text-xl font-bold border-l-4 border-transparent transition-all shadow-md active:scale-95";
                
                btnB.innerHTML = `ğŸ…±ï¸ è®¾ç»ˆç‚¹ (B)`;
                btnB.className = "bg-gray-700 hover:bg-gray-600 text-white py-4 rounded-xl text-xl font-bold border-l-4 border-transparent transition-all shadow-md opacity-50 cursor-not-allowed active:scale-95";
                btnB.disabled = true;
                
                document.getElementById('loop-indicator').classList.add('hidden');
            }
        }

        function changeSpeed(val) {
            player.speed = parseFloat(val);
        }

        // === å†å²è®°å½• ===
        function saveHistory() {
            if (!currentMedia.id) return;
            const record = {
                id: currentMedia.id,
                title: currentMedia.title,
                type: currentMedia.type,
                timestamp: player.currentTime,
                loop: (loopA && loopB) ? { a: loopA, b: loopB } : null,
                date: new Date().getTime()
            };
            
            const index = historyData.findIndex(h => h.id === record.id && h.type === record.type);
            if (index > -1) historyData.splice(index, 1);
            historyData.unshift(record);
            if (historyData.length > 20) historyData.pop();
            
            localStorage.setItem('video_ab_history_v2', JSON.stringify(historyData));
            renderHistoryUI();
        }

        function renderHistoryUI() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            
            if (historyData.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-600 mt-10 text-xs">æš‚æ— å†å²è®°å½•</div>';
                return;
            }

            historyData.forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-gray-800 hover:bg-gray-700 p-3 rounded-lg cursor-pointer transition-all border border-gray-700 hover:border-blue-500 group";
                const isYt = item.type === 'youtube';
                
                div.innerHTML = `
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xs font-bold px-1.5 py-0.5 rounded ${isYt ? 'bg-red-900 text-red-200' : 'bg-blue-900 text-blue-200'}">
                            ${isYt ? 'YT' : 'FILE'}
                        </span>
                        <div class="text-xs font-bold text-gray-300 truncate flex-1">${item.title}</div>
                    </div>
                    <div class="flex justify-between items-end">
                        <div class="text-[10px] text-gray-500">
                            è¿›åº¦: <span class="text-blue-400 font-mono">${formatTime(item.timestamp)}</span>
                        </div>
                        ${item.loop ? '<span class="text-[10px] bg-green-900 text-green-300 px-1 rounded">A-B</span>' : ''}
                    </div>
                `;
                div.onclick = () => restoreHistory(item);
                list.appendChild(div);
            });
        }

        function restoreHistory(item) {
            if (item.type === 'youtube') {
                switchMode('youtube');
                document.getElementById('yt-url').value = `https://youtu.be/${item.id}`;
                loadYouTube(null, item.timestamp, item.loop);
            } else {
                switchMode('local');
                alert(`âš ï¸ è¯·é‡æ–°é€‰æ‹©æœ¬åœ°æ–‡ä»¶ï¼š\n${item.id}`);
                // é«˜äº®æ–‡ä»¶æ¡†
                const box = document.getElementById('input-local');
                box.classList.add('ring-2', 'ring-blue-500');
                setTimeout(() => box.classList.remove('ring-2', 'ring-blue-500'), 2000);
            }
        }

        function clearHistory() {
            if(confirm('æ¸…ç©ºæ‰€æœ‰è®°å½•ï¼Ÿ')) {
                localStorage.removeItem('video_ab_history_v2');
                historyData = [];
                renderHistoryUI();
            }
        }

        function formatTime(s) {
            if (!s) return "0:00";
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec.toString().padStart(2, '0')}`;
        }

        // å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            if (e.code === 'ArrowLeft') setA();
            if (e.code === 'ArrowRight') setB();
            if (e.code === 'Escape') clearLoop();
        });
    </script>
</body>
</html>