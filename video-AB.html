<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A-B è§†é¢‘æ’­æ”¾å™¨ V3 (å¾®è°ƒå¢å¼ºç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    
    <style>
        .plyr { height: 100%; max-height: 70vh; border-radius: 0.75rem; --plyr-color-main: #2563eb; }
        body { background-color: #0f172a; color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <div class="flex-1 flex flex-col p-4 space-y-4 overflow-y-auto">
        
        <div class="bg-gray-800 p-4 rounded-xl shadow-lg flex gap-4 items-center">
            <div class="flex bg-gray-700 rounded-lg p-1 shrink-0">
                <button onclick="switchMode('youtube')" id="tab-yt" class="px-4 py-2 rounded-md text-sm font-bold bg-blue-600 transition-all">YouTube</button>
                <button onclick="switchMode('local')" id="tab-local" class="px-4 py-2 rounded-md text-sm font-bold text-gray-400 hover:text-white transition-all">æœ¬åœ°è§†é¢‘</button>
            </div>

            <div id="input-youtube" class="flex-1 flex gap-2">
                <input type="text" id="yt-url" placeholder="ç²˜è´´ YouTube ç½‘å€" 
                       class="flex-1 bg-gray-900 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500 font-mono text-sm">
                <button onclick="loadYouTube()" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg font-bold shadow-lg">æ’­æ”¾</button>
            </div>

            <div id="input-local" class="flex-1 hidden">
                <input type="file" id="local-file" accept="video/*" class="block w-full text-sm text-gray-400
                  file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0
                  file:text-sm file:font-semibold file:bg-blue-600 file:text-white
                  hover:file:bg-blue-500 cursor-pointer"/>
            </div>
        </div>

        <div class="w-full bg-black rounded-xl shadow-2xl relative group aspect-video flex justify-center items-center overflow-hidden border border-gray-700">
            <video id="player" playsinline controls class="w-full h-full"></video>
            
            <div id="loop-indicator" class="absolute top-4 right-4 bg-blue-600/90 px-3 py-1 rounded text-xs font-bold hidden backdrop-blur-md shadow-lg z-50 animate-pulse">
                ğŸ”„ å¾ªç¯ä¸­
            </div>
        </div>

        <div class="grid grid-cols-12 gap-4">
            
            <div class="col-span-5 flex flex-col gap-1">
                <button onclick="setA()" id="btn-a" class="w-full bg-gray-700 hover:bg-gray-600 text-white py-4 rounded-xl text-xl font-bold border-l-4 border-transparent transition-all shadow-md active:scale-95 relative group">
                    <span id="text-a">ğŸ…°ï¸ è®¾èµ·ç‚¹ (A)</span>
                    <span class="absolute right-2 bottom-2 text-xs text-blue-300 opacity-0 group-hover:opacity-100 transition">ç‚¹å‡»æ›´æ–°</span>
                </button>
                <button onclick="clearPoint('a')" class="w-full py-1 text-xs text-gray-500 hover:text-red-400 bg-gray-800 rounded hover:bg-gray-700 transition">
                    ğŸ—‘ï¸ æ¸…é™¤ Aç‚¹
                </button>
            </div>

            <div class="col-span-5 flex flex-col gap-1">
                <button onclick="setB()" id="btn-b" disabled class="w-full bg-gray-700 hover:bg-gray-600 text-white py-4 rounded-xl text-xl font-bold border-l-4 border-transparent transition-all shadow-md opacity-50 cursor-not-allowed active:scale-95 relative group">
                    <span id="text-b">ğŸ…±ï¸ è®¾ç»ˆç‚¹ (B)</span>
                    <span class="absolute right-2 bottom-2 text-xs text-blue-300 opacity-0 group-hover:opacity-100 transition">ç‚¹å‡»æ›´æ–°</span>
                </button>
                <button onclick="clearPoint('b')" class="w-full py-1 text-xs text-gray-500 hover:text-red-400 bg-gray-800 rounded hover:bg-gray-700 transition">
                    ğŸ—‘ï¸ æ¸…é™¤ Bç‚¹
                </button>
            </div>

            <div class="col-span-2 flex flex-col gap-2">
                 <button onclick="clearAll()" class="bg-red-900/40 hover:bg-red-800 text-red-200 py-2 rounded-lg text-sm font-bold shadow-md active:scale-95 h-1/2">
                    âŒ å…¨æ¸…
                </button>
                
                <div class="bg-gray-800 rounded-lg flex items-center justify-center relative group cursor-pointer hover:bg-gray-700 transition h-1/2">
                    <select id="speed-select" onchange="changeSpeed(this.value)" class="bg-transparent text-white font-bold text-sm text-center outline-none cursor-pointer appearance-none w-full h-full absolute inset-0 z-10">
                        <option value="0.5" class="bg-gray-800">0.5x</option>
                        <option value="0.75" class="bg-gray-800">0.75x</option>
                        <option value="1.0" selected class="bg-gray-800">1.0x</option>
                        <option value="1.25" class="bg-gray-800">1.25x</option>
                        <option value="1.5" class="bg-gray-800">1.5x</option>
                        <option value="2.0" class="bg-gray-800">2.0x</option>
                    </select>
                    <div class="text-sm font-bold pointer-events-none z-0" id="speed-display">1.0x</div>
                </div>
            </div>
        </div>
        
        <div class="text-center text-xs text-gray-500 mt-2">
            æç¤ºï¼šåœ¨å¾ªç¯ä¸­ï¼Œå†æ¬¡ç‚¹å‡» A æˆ– B å¯ç›´æ¥æ›´æ–°æ—¶é—´ï¼Œä¸ä¼šæ‰“æ–­å¾ªç¯ã€‚
        </div>
    </div>

    <div class="w-80 bg-gray-900 border-l border-gray-800 flex flex-col shadow-2xl z-20">
        <div class="p-4 border-b border-gray-800 bg-gray-900 flex justify-between items-center">
            <h2 class="text-sm font-bold text-gray-300">ğŸ“œ æ’­æ”¾å†å²</h2>
            <button onclick="clearHistory()" class="text-xs text-gray-600 hover:text-red-400">æ¸…ç©º</button>
        </div>
        <div id="history-list" class="flex-1 overflow-y-auto p-3 space-y-3"></div>
    </div>

    <script>
        let player = null;
        let loopA = null;
        let loopB = null;
        let currentMode = 'youtube';
        let historyData = JSON.parse(localStorage.getItem('video_ab_history_v3')) || [];
        let currentMedia = { id: null, title: null, type: null };

        document.addEventListener('DOMContentLoaded', () => {
            player = new Plyr('#player', {
                controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen'],
                keyboard: { focused: true, global: true },
                speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] },
                youtube: { noCookie: true, rel: 0, showinfo: 0, iv_load_policy: 3, modestbranding: 1 }
            });

            // === æ ¸å¿ƒå¾ªç¯é€»è¾‘ V3 ===
            player.on('timeupdate', () => {
                // åªæœ‰å½“ A å’Œ B éƒ½å­˜åœ¨ï¼Œä¸” B > A æ—¶æ‰å¾ªç¯
                if (loopA !== null && loopB !== null && loopB > loopA) {
                    // å¢åŠ  0.2s ç¼“å†²ï¼Œä½“éªŒæ›´ä¸æ»‘
                    if (player.currentTime >= loopB || player.currentTime < loopA - 0.5) {
                        player.currentTime = loopA;
                        player.play().catch(()=>{});
                    }
                }
                if (Math.floor(player.currentTime) % 5 === 0) saveHistory();
            });

            player.on('ratechange', () => {
                 document.getElementById('speed-display').innerText = player.speed + 'x';
                 document.getElementById('speed-select').value = player.speed;
            });

            renderHistoryUI();
        });

        // === é€»è¾‘ä¼˜åŒ–ï¼šæ™ºèƒ½è®¾ç½® A ç‚¹ ===
        function setA() {
            const t = player.currentTime;
            
            // å¦‚æœ B å·²ç»å­˜åœ¨
            if (loopB !== null) {
                if (t < loopB) {
                    // æƒ…å†µ1ï¼šæ–°çš„ A åœ¨ B ä¹‹å‰ï¼ˆåˆæ³•å¾®è°ƒï¼‰ -> æ›´æ–° Aï¼Œä¿æŒ Bï¼Œä¿æŒå¾ªç¯
                    loopA = t;
                    // ä¸åšä»»ä½•æ¸…é™¤æ“ä½œ
                } else {
                    // æƒ…å†µ2ï¼šæ–°çš„ A æ¯” B è¿˜å¤§ï¼ˆä¸åˆæ³•ï¼‰ -> æ›´æ–° Aï¼Œå¿…é¡»æ¸…é™¤ B
                    loopA = t;
                    loopB = null; 
                    // æ­¤æ—¶å¾ªç¯è‡ªç„¶æš‚åœï¼Œç­‰å¾…è®¾ç½®æ–° B
                }
            } else {
                // B ä¸å­˜åœ¨ï¼Œç›´æ¥è®¾ A
                loopA = t;
            }
            
            updateUI();
            saveHistory();
        }

        // === é€»è¾‘ä¼˜åŒ–ï¼šæ™ºèƒ½è®¾ç½® B ç‚¹ ===
        function setB() {
            if (loopA === null) {
                // å¦‚æœæ²¡æœ‰ Aï¼Œå…ˆä¸è®©è®¾ B (æˆ–è€…ä½ å¯ä»¥æ”¹æˆè‡ªåŠ¨è®¾ A ä¸º 0)
                return alert("è¯·å…ˆè®¾ç½®èµ·ç‚¹ A");
            }

            const t = player.currentTime;
            
            if (t > loopA) {
                // æƒ…å†µ1ï¼šB åœ¨ A ä¹‹åï¼ˆåˆæ³•ï¼‰ -> æ›´æ–° Bï¼Œç«‹å³å¾ªç¯
                loopB = t;
                // ç«‹å³è·³å› A éªŒè¯å¾ªç¯
                player.currentTime = loopA;
                player.play();
            } else {
                // æƒ…å†µ2ï¼šB åœ¨ A ä¹‹å‰ï¼ˆä¸åˆæ³•ï¼‰ -> å¯èƒ½æ˜¯ç‚¹é”™äº†ï¼Œäº¤æ¢ A Bï¼Ÿ
                // è¿™é‡Œæˆ‘ä»¬ç®€å•å¤„ç†ï¼šåªæ›´æ–° Bï¼Œä½†å› ä¸º B < Aï¼Œå¾ªç¯é€»è¾‘ä¼šæš‚æ—¶å¤±æ•ˆï¼Œç›´åˆ°ä½ ä¿®æ­£ A
                // æˆ–è€…æˆ‘ä»¬å¯ä»¥æŠŠç°åœ¨çš„ A å˜æˆ Bï¼Œç°åœ¨çš„ t å˜æˆ A
                const oldA = loopA;
                loopA = t;
                loopB = oldA;
                // ç«‹å³æ’­æ”¾
                player.currentTime = loopA;
                player.play();
            }

            updateUI();
            saveHistory();
        }

        function clearPoint(point) {
            if (point === 'a') loopA = null;
            if (point === 'b') loopB = null;
            updateUI();
            saveHistory();
        }

        function clearAll() {
            loopA = null;
            loopB = null;
            updateUI();
            saveHistory();
        }

        function updateUI() {
            const btnA = document.getElementById('btn-a');
            const btnB = document.getElementById('btn-b');
            const txtA = document.getElementById('text-a');
            const txtB = document.getElementById('text-b');
            const indicator = document.getElementById('loop-indicator');

            // æ›´æ–° A æŒ‰é’®çŠ¶æ€
            if (loopA !== null) {
                txtA.innerHTML = `<span class="text-xs opacity-60">èµ·ç‚¹</span><br>${formatTime(loopA)}`;
                btnA.classList.add('bg-blue-600', 'border-blue-300');
                btnA.classList.remove('bg-gray-700', 'border-transparent');
                // æ¿€æ´» B
                btnB.disabled = false;
                btnB.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                txtA.innerText = "ğŸ…°ï¸ è®¾èµ·ç‚¹ (A)";
                btnA.classList.add('bg-gray-700', 'border-transparent');
                btnA.classList.remove('bg-blue-600', 'border-blue-300');
                // ç¦ç”¨ B (å¦‚æœæ²¡æœ‰ Aï¼Œé€šå¸¸ä¸è®¾ B)
                btnB.disabled = true;
                btnB.classList.add('opacity-50', 'cursor-not-allowed');
            }

            // æ›´æ–° B æŒ‰é’®çŠ¶æ€
            if (loopB !== null) {
                txtB.innerHTML = `<span class="text-xs opacity-60">ç»ˆç‚¹</span><br>${formatTime(loopB)}`;
                btnB.classList.add('bg-blue-600', 'border-blue-300');
                btnB.classList.remove('animate-pulse'); // åªæœ‰åœ¨å¾…è®¾ç½®æ—¶é—ªçƒï¼Ÿæˆ–è€…ä¿æŒé«˜äº®
            } else {
                txtB.innerText = "ğŸ…±ï¸ è®¾ç»ˆç‚¹ (B)";
                btnB.classList.remove('bg-blue-600', 'border-blue-300');
                if (loopA !== null) btnB.classList.add('animate-pulse'); // æç¤ºå»ç‚¹ B
            }

            // å¾ªç¯çŠ¶æ€æŒ‡ç¤ºå™¨
            if (loopA !== null && loopB !== null && loopB > loopA) {
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }
        }

        // === åŸºç¡€åŠŸèƒ½ä¿æŒä¸å˜ ===
        function switchMode(mode) {
            currentMode = mode;
            const btnYt = document.getElementById('tab-yt');
            const btnLocal = document.getElementById('tab-local');
            const inputYt = document.getElementById('input-youtube');
            const inputLocal = document.getElementById('input-local');

            if (mode === 'youtube') {
                btnYt.className = "px-4 py-2 rounded-md text-sm font-bold bg-blue-600 text-white shadow-lg";
                btnLocal.className = "px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-white";
                inputYt.classList.remove('hidden'); inputYt.classList.add('flex');
                inputLocal.classList.add('hidden');
            } else {
                btnLocal.className = "px-4 py-2 rounded-md text-sm font-bold bg-blue-600 text-white shadow-lg";
                btnYt.className = "px-4 py-2 rounded-md text-sm font-bold text-gray-500 hover:text-white";
                inputLocal.classList.remove('hidden');
                inputYt.classList.remove('flex'); inputYt.classList.add('hidden');
            }
        }

        function loadYouTube(urlOverride = null, startAt = 0, loopPoints = null) {
            const url = urlOverride || document.getElementById('yt-url').value;
            if (!url) return alert("è¯·è¾“å…¥ YouTube ç½‘å€");
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            
            if (match && match[2].length === 11) {
                const videoId = match[2];
                player.source = { type: 'video', sources: [{ src: videoId, provider: 'youtube' }] };
                currentMedia = { id: videoId, title: `YouTube (${videoId})`, type: 'youtube' };
                clearAll();
                setTimeout(() => { const poster = document.querySelector('.plyr__poster'); if(poster) poster.style.display = 'none'; }, 1000);
                player.once('ready', () => {
                    if (startAt > 0) player.currentTime = startAt;
                    if (loopPoints) { loopA = loopPoints.a; loopB = loopPoints.b; updateUI(); }
                    saveHistory();
                });
            } else { alert("æ— æ•ˆé“¾æ¥"); }
        }

        document.getElementById('local-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            player.source = { type: 'video', sources: [{ src: url, type: file.type || 'video/mp4' }] };
            currentMedia = { id: file.name, title: file.name, type: 'local' };
            clearAll();
            const saved = historyData.find(h => h.id === file.name && h.type === 'local');
            player.once('ready', () => {
                if (saved) {
                    player.currentTime = saved.timestamp;
                    if (saved.loop) { loopA = saved.loop.a; loopB = saved.loop.b; updateUI(); }
                    player.play().catch(()=>{});
                }
                saveHistory();
            });
        });

        function changeSpeed(val) { player.speed = parseFloat(val); }

        function saveHistory() {
            if (!currentMedia.id) return;
            const record = {
                id: currentMedia.id, title: currentMedia.title, type: currentMedia.type,
                timestamp: player.currentTime,
                loop: (loopA && loopB) ? { a: loopA, b: loopB } : null,
                date: new Date().getTime()
            };
            const index = historyData.findIndex(h => h.id === record.id && h.type === record.type);
            if (index > -1) historyData.splice(index, 1);
            historyData.unshift(record);
            if (historyData.length > 20) historyData.pop();
            localStorage.setItem('video_ab_history_v3', JSON.stringify(historyData));
            renderHistoryUI();
        }

        function renderHistoryUI() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            if (historyData.length === 0) return list.innerHTML = '<div class="text-center text-gray-600 mt-10 text-xs">æš‚æ— è®°å½•</div>';
            historyData.forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-gray-800 hover:bg-gray-700 p-3 rounded-lg cursor-pointer transition-all border border-gray-700 hover:border-blue-500 group";
                const isYt = item.type === 'youtube';
                div.innerHTML = `
                    <div class="flex items-center gap-2 mb-2"><span class="text-xs font-bold px-1.5 py-0.5 rounded ${isYt ? 'bg-red-900 text-red-200' : 'bg-blue-900 text-blue-200'}">${isYt ? 'YT' : 'FILE'}</span><div class="text-xs font-bold text-gray-300 truncate flex-1">${item.title}</div></div>
                    <div class="flex justify-between items-end"><div class="text-[10px] text-gray-500">è¿›åº¦: <span class="text-blue-400 font-mono">${formatTime(item.timestamp)}</span></div>${item.loop ? '<span class="text-[10px] bg-green-900 text-green-300 px-1 rounded">A-B</span>' : ''}</div>
                `;
                div.onclick = () => restoreHistory(item);
                list.appendChild(div);
            });
        }

        function restoreHistory(item) {
            if (item.type === 'youtube') {
                switchMode('youtube'); document.getElementById('yt-url').value = `https://youtu.be/${item.id}`;
                loadYouTube(null, item.timestamp, item.loop);
            } else {
                switchMode('local'); alert(`è¯·é‡æ–°é€‰æ‹©æ–‡ä»¶ï¼š\n${item.id}`);
                const box = document.getElementById('input-local'); box.classList.add('ring-2', 'ring-blue-500'); setTimeout(() => box.classList.remove('ring-2', 'ring-blue-500'), 2000);
            }
        }

        function clearHistory() { if(confirm('æ¸…ç©ºæ‰€æœ‰ï¼Ÿ')) { localStorage.removeItem('video_ab_history_v3'); historyData = []; renderHistoryUI(); } }
        function formatTime(s) { if (!s) return "0:00"; const m = Math.floor(s / 60); const sec = Math.floor(s % 60); return `${m}:${sec.toString().padStart(2, '0')}`; }

        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            if (e.code === 'ArrowLeft') setA();
            if (e.code === 'ArrowRight') setB();
            if (e.code === 'Escape') clearAll();
        });
    </script>
</body>
</html>