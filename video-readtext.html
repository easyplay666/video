<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>双语教学视频制作工具</title>
    <script src="https://unpkg.com/pinyin-pro"></script>
    <style>
        :root { --yt-red: #cc0000; --paper: #fdf5e6; --accent: #b03a2e; --highlight: #cc0000; }
        body { 
            font-family: "PingFang SC", "Kaiti", "STKaiti", serif; 
            background: #1a1a1a; color: white; margin: 0; 
            display: flex; flex-direction: column; align-items: center; overflow-x: hidden;
        }
        
        /* UI控制区 */
        #ui-controls { 
            background: #333; padding: 20px; width: 100%; 
            display: flex; flex-direction: column; align-items: center; gap: 15px; 
            box-sizing: border-box; z-index: 2000;
        }
        .controls-row { display: flex; gap: 15px; align-items: center; width: 100%; justify-content: center; }
        .ratio-selector { display: flex; gap: 5px; background: #444; padding: 5px; border-radius: 6px; }
        .ratio-btn { padding: 8px 15px; cursor: pointer; border-radius: 4px; border: none; background: transparent; color: #ccc; font-size: 13px; }
        .ratio-btn.active { background: #666; color: white; }
        
        /* 大文本输入框 */
        textarea { 
            width: 80%; max-width: 800px; height: 120px; 
            padding: 12px; border: none; border-radius: 4px; 
            font-size: 16px; font-family: inherit; resize: vertical;
        }
        
        #startBtn { padding: 12px 30px; cursor: pointer; background: var(--yt-red); color: white; border: none; border-radius: 4px; font-weight: bold; font-size: 16px; }

        /* 视频舞台容器 */
        #stage-viewport { margin: 20px auto; display: flex; justify-content: center; align-items: center; background: #000; }
        #recording-stage {
            background-color: var(--paper);
            background-image: url("https://www.transparenttextures.com/patterns/handmade-paper.png");
            color: #2c3e50; display: flex; flex-direction: column; 
            padding: 40px; box-sizing: border-box; position: relative; overflow: hidden;
        }

        .mode-youtube { width: 854px; height: 480px; }
        .mode-mobile { width: 360px; height: 640px; }

        /* 录制模式样式 */
        body.is-recording #ui-controls { display: none; }
        body.is-recording #stage-viewport { margin: 0; width: 100vw; height: 100vh; }
        body.is-recording .mode-youtube { width: 177.78vh; height: 100vh; max-width: 100vw; }
        body.is-recording .mode-mobile { width: 56.25vh; height: 100vh; max-height: 177.78vw; }

        /* 内容显示区 */
        #content-area {
            flex-grow: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center; gap: 30px; text-align: center;
        }
        
        .text-line {
            font-size: 32px; line-height: 1.4; color: #333;
            transition: all 0.4s ease; opacity: 0.8; width: 100%;
        }
        
        /* 高亮效果：变色并放大 */
        .text-line.active { 
            color: var(--highlight); 
            transform: scale(1.1); 
            opacity: 1; 
            font-weight: bold; 
        }

        /* Logo */
        #logo-area { position: absolute; top: 20px; left: 20px; display: flex; align-items: center; gap: 8px; }
        .logo-icon { width: 30px; height: 30px; background: var(--accent); color: white; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .logo-cn { font-size: 14px; font-weight: bold; }

        #download-link { position: fixed; top: 20px; right: 20px; background: #27ae60; padding: 12px 20px; color: white; border-radius: 8px; text-decoration: none; display: none; z-index: 3000; }
    </style>
</head>
<body>

<div id="ui-controls">
    <div class="controls-row">
        <div class="ratio-selector">
            <button id="btn-yt" class="ratio-btn active" onclick="setMode('youtube')">YouTube (16:9)</button>
            <button id="btn-mb" class="ratio-btn" onclick="setMode('mobile')">手机竖屏 (9:16)</button>
        </div>
        <button id="startBtn">开始录制并制作</button>
    </div>
    <textarea id="multiInput" placeholder="请输入内容，每行一句。例如：&#10;Bonjour tout le monde&#10;大家好">Apprendre le français est amusant.
学习法语很有趣。</textarea>
</div>

<div id="stage-viewport">
    <div id="recording-stage" class="mode-youtube">
        <div id="logo-area">
            <div class="logo-icon">学</div>
            <div class="logo-cn">法语中文教学</div>
        </div>
        <div id="content-area">
            </div>
    </div>
</div>

<a id="download-link" href="#">⬇ 下载录制视频</a>

<script>
    const startBtn = document.getElementById('startBtn');
    const downloadLink = document.getElementById('download-link');
    const stage = document.getElementById('recording-stage');
    const contentArea = document.getElementById('content-area');
    let currentMode = 'youtube';

    function setMode(mode) {
        currentMode = mode;
        document.getElementById('btn-yt').classList.toggle('active', mode === 'youtube');
        document.getElementById('btn-mb').classList.toggle('active', mode === 'mobile');
        stage.className = mode === 'youtube' ? 'mode-youtube' : 'mode-mobile';
    }

    // 智能检测语种并朗读
    function speak(text) {
        return new Promise((resolve) => {
            const utterance = new SpeechSynthesisUtterance(text);
            // 简单判断：包含中文字符则设为中文，否则设为法语
            const isChinese = /[\u4e00-\u9fa5]/.test(text);
            utterance.lang = isChinese ? 'zh-CN' : 'fr-FR';
            utterance.rate = 0.85;
            utterance.onend = resolve;
            window.speechSynthesis.speak(utterance);
        });
    }

    async function startProcess() {
        const fullText = document.getElementById('multiInput').value;
        const lines = fullText.split('\n').filter(line => line.trim() !== '');
        if(lines.length === 0) return;

        try {
            // 1. 请求屏幕录制（请选择当前浏览器标签页）
            const stream = await navigator.mediaDevices.getDisplayMedia({
                video: { displaySurface: "browser" },
                audio: { echoCancellation: false }
            });

            document.body.classList.add('is-recording');
            downloadLink.style.display = "none";
            
            const recorder = new MediaRecorder(stream, { 
                mimeType: 'video/webm;codecs=vp9', 
                videoBitsPerSecond: 8000000 
            });
            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                downloadLink.href = URL.createObjectURL(blob);
                downloadLink.download = `teaching_video.webm`;
                downloadLink.style.display = "block";
                document.body.classList.remove('is-recording');
            };

            // 2. 初始化显示内容
            contentArea.innerHTML = '';
            const lineElements = lines.map(text => {
                const div = document.createElement('div');
                div.className = 'text-line';
                div.innerText = text;
                contentArea.appendChild(div);
                return div;
            });

            // 3. 开始录制
            recorder.start();
            await new Promise(r => setTimeout(r, 1000)); // 留白1秒

            // 4. 循环处理每一行
            for (let i = 0; i < lineElements.length; i++) {
                const el = lineElements[i];
                
                // 高亮当前行
                el.classList.add('active');
                
                // 朗读
                await speak(lines[i]);
                
                // 稍微停顿
                await new Promise(r => setTimeout(r, 500));
                
                // 移除高亮
                el.classList.remove('active');
            }

            await new Promise(r => setTimeout(r, 1000)); // 结束留白

            // 5. 停止录制
            recorder.stop();
            stream.getTracks().forEach(t => t.stop());

        } catch (err) {
            console.error(err);
            document.body.classList.remove('is-recording');
        }
    }

    startBtn.addEventListener('click', startProcess);
</script>

</body>
</html>
