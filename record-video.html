<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>HTML 视频录制（修复版）</title>

<style>
  body { font-family: Arial; text-align: center; margin-top: 20px; }
  canvas { border: 1px solid #ccc; }
  button, select, input { margin: 5px; padding: 6px 10px; }
</style>
</head>

<body>

<h2>HTML 视频录制（暂停 / 尺寸 / 可换背景）</h2>

<video id="camera" autoplay muted playsinline style="display:none"></video>
<canvas id="canvas"></canvas>
<br>

<select id="format">
  <option value="landscape">YouTube 横屏 (16:9)</option>
  <option value="portrait">手机竖屏 (9:16)</option>
</select>

<select id="bgMode">
  <option value="none">无背景</option>
  <option value="color">纯色背景</option>
  <option value="image">图片背景</option>
</select>

<input type="file" id="bgUpload" accept="image/*">

<br>

<button id="init">开启摄像头</button>
<button id="start" disabled>开始录制</button>
<button id="pause" disabled>暂停</button>
<button id="resume" disabled>继续</button>
<button id="stop" disabled>停止</button>

<script>
const video = document.getElementById("camera");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let stream, recorder, chunks = [];
let bgImage = new Image();
let drawing = false;

function setCanvasSize() {
  if (format.value === "portrait") {
    canvas.width = 720;
    canvas.height = 1280;
  } else {
    canvas.width = 1280;
    canvas.height = 720;
  }
}

function draw() {
  if (!drawing) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // 背景
  if (bgMode.value === "color") {
    ctx.fillStyle = "#2c3e50";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  } else if (bgMode.value === "image" && bgImage.src) {
    ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
  }

  // 人像视频
  const vw = video.videoWidth;
  const vh = video.videoHeight;

  if (vw && vh) {
    const scale = Math.min(canvas.width / vw, canvas.height / vh);
    const w = vw * scale;
    const h = vh * scale;

    ctx.drawImage(
      video,
      (canvas.width - w) / 2,
      (canvas.height - h) / 2,
      w,
      h
    );
  }

  requestAnimationFrame(draw);
}

// 上传背景图
document.getElementById("bgUpload").onchange = e => {
  const file = e.target.files[0];
  if (file) {
    bgImage.src = URL.createObjectURL(file);
  }
};

// 开启摄像头
document.getElementById("init").onclick = async () => {
  stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  video.srcObject = stream;

  await video.play(); // ⭐ 关键修复点

  setCanvasSize();
  drawing = true;
  draw();

  document.getElementById("start").disabled = false;
};

// 开始录制
document.getElementById("start").onclick = () => {
  const canvasStream = canvas.captureStream(30);
  stream.getAudioTracks().forEach(t => canvasStream.addTrack(t));

  recorder = new MediaRecorder(canvasStream);
  recorder.ondataavailable = e => chunks.push(e.data);

  recorder.onstop = () => {
    const blob = new Blob(chunks, { type: "video/webm" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "recorded-video.webm";
    a.click();
    chunks = [];
  };

  recorder.start();
  pause.disabled = false;
  stop.disabled = false;
};

// 暂停 / 继续
pause.onclick = () => recorder.pause();
resume.onclick = () => recorder.resume();
stop.onclick = () => recorder.stop();
</script>

</body>
</html>
