<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>HTML 视频录制（逻辑整理版）</title>

<style>
  body { font-family: Arial; text-align: center; margin-top: 20px; }
  canvas { border: 1px solid #ccc; }
  button { margin: 5px; padding: 8px 14px; }
  #timer { font-size: 18px; margin-top: 10px; }
</style>
</head>

<body>

<h2>HTML 视频录制（状态逻辑正确）</h2>

<video id="camera" autoplay muted playsinline style="display:none"></video>
<canvas id="canvas" width="1280" height="720"></canvas>

<div id="timer">00:00</div>

<br>

<button id="init">开启摄像头</button>
<button id="start" disabled>开始录制</button>
<button id="pause" disabled>暂停</button>
<button id="resume" disabled>继续</button>
<button id="stop" disabled>停止</button>

<script>
const video = document.getElementById("camera");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let stream, recorder, chunks = [];
let state = "idle";
let drawing = false;

let seconds = 0;
let timerInterval = null;

// ====== 状态控制 ======
function updateButtons() {
  start.disabled  = !(state === "idle" || state === "stopped");
  pause.disabled  = state !== "recording";
  resume.disabled = state !== "paused";
  stop.disabled   = !(state === "recording" || state === "paused");
}

// ====== 计时器 ======
function startTimer() {
  timerInterval = setInterval(() => {
    seconds++;
    const m = String(Math.floor(seconds / 60)).padStart(2, "0");
    const s = String(seconds % 60).padStart(2, "0");
    timer.textContent = `${m}:${s}`;
  }, 1000);
}

function stopTimer() {
  clearInterval(timerInterval);
}

// ====== 绘制 ======
function draw() {
  if (!drawing) return;

  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  requestAnimationFrame(draw);
}

// ====== 初始化摄像头 ======
init.onclick = async () => {
  stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  video.srcObject = stream;
  await video.play();

  start.disabled = false;
};

// ====== 开始录制 ======
start.onclick = () => {
  chunks = [];
  seconds = 0;
  timer.textContent = "00:00";

  const canvasStream = canvas.captureStream(30);
  stream.getAudioTracks().forEach(t => canvasStream.addTrack(t));

  recorder = new MediaRecorder(canvasStream);
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    const blob = new Blob(chunks, { type: "video/webm" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "recorded-video.webm";
    a.click();
  };

  recorder.start();
  state = "recording";
  drawing = true;
  draw();
  startTimer();
  updateButtons();
};

// ====== 暂停 ======
pause.onclick = () => {
  recorder.pause();
  drawing = false;   // ⭐ 画面冻结
  stopTimer();
  state = "paused";
  updateButtons();
};

// ====== 继续 ======
resume.onclick = () => {
  recorder.resume();
  drawing = true;
  draw();
  startTimer();
  state = "recording";
  updateButtons();
};

// ====== 停止 ======
stop.onclick = () => {
  recorder.stop();
  drawing = false;
  stopTimer();
  state = "stopped";
  updateButtons();
};
</script>

</body>
</html>
