<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>HTML 视频录制（专业版）</title>

<style>
  body { font-family: Arial; text-align: center; margin-top: 20px; }
  canvas { border: 1px solid #ccc; }
  select, button { margin: 5px; padding: 8px 12px; }
</style>
</head>

<body>

<h2>HTML 视频录制（支持暂停 / 尺寸 / 虚拟背景）</h2>

<video id="camera" autoplay muted playsinline style="display:none"></video>
<canvas id="canvas"></canvas>
<br>

<select id="format">
  <option value="landscape">YouTube 横屏 (16:9)</option>
  <option value="portrait">手机竖屏 (9:16)</option>
</select>

<select id="background">
  <option value="none">无背景</option>
  <option value="color">纯色背景</option>
  <option value="image">图片背景</option>
</select>

<br>

<button id="init">开启摄像头</button>
<button id="start" disabled>开始录制</button>
<button id="pause" disabled>暂停</button>
<button id="resume" disabled>继续</button>
<button id="stop" disabled>停止</button>

<script>
let stream, recorder, chunks = [];
const video = document.getElementById("camera");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const format = document.getElementById("format");
const bgSelect = document.getElementById("background");

let bgImage = new Image();
bgImage.src = "https://picsum.photos/1280/720"; // 示例背景

function setCanvasSize() {
  if (format.value === "portrait") {
    canvas.width = 720;
    canvas.height = 1280;
  } else {
    canvas.width = 1280;
    canvas.height = 720;
  }
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // 背景
  if (bgSelect.value === "color") {
    ctx.fillStyle = "#2c3e50";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  } else if (bgSelect.value === "image") {
    ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
  }

  // 人像视频（居中）
  const scale = Math.min(
    canvas.width / video.videoWidth,
    canvas.height / video.videoHeight
  );

  const w = video.videoWidth * scale;
  const h = video.videoHeight * scale;

  ctx.drawImage(
    video,
    (canvas.width - w) / 2,
    (canvas.height - h) / 2,
    w,
    h
  );

  requestAnimationFrame(draw);
}

document.getElementById("init").onclick = async () => {
  stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  video.srcObject = stream;

  setCanvasSize();
  draw();

  document.getElementById("start").disabled = false;
};

document.getElementById("start").onclick = () => {
  const canvasStream = canvas.captureStream(30);
  stream.getAudioTracks().forEach(t => canvasStream.addTrack(t));

  recorder = new MediaRecorder(canvasStream);
  recorder.ondataavailable = e => chunks.push(e.data);

  recorder.onstop = () => {
    const blob = new Blob(chunks, { type: "video/webm" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "video.webm";
    a.click();
    chunks = [];
  };

  recorder.start();
  document.getElementById("pause").disabled = false;
  document.getElementById("stop").disabled = false;
};

document.getElementById("pause").onclick = () => {
  recorder.pause();
  document.getElementById("resume").disabled = false;
};

document.getElementById("resume").onclick = () => {
  recorder.resume();
};

document.getElementById("stop").onclick = () => {
  recorder.stop();
};
</script>

</body>
</html>
